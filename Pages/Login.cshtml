@page
@model AceJob.Pages.LoginModel
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@{
    ViewData["Title"] = "Login - AceJob";
    var siteKey = Configuration["RecaptchaSettings:SiteKey"];
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
     <div class="col-sm-12 col-md-8 col-lg-5 col-xl-4">
  <div class="card shadow-lg border-0">
    <div class="card-body p-4">
         <!-- Header -->
  <div class="text-center mb-4">
         <div class="mb-3">
        <i class="bi bi-shield-lock-fill text-primary" style="font-size: 3rem;"></i>
       </div>
           <h1 class="h3 mb-2 fw-bold">Welcome Back</h1>
           <p class="text-muted small">Sign in to your AceJob account</p>
       </div>

          @if (!string.IsNullOrEmpty(Model.InfoMessage))
            {
          <div class="alert alert-info d-flex align-items-center" role="alert">
        <i class="bi bi-info-circle me-2"></i>
      <div>@Model.InfoMessage</div>
           </div>
   }

      <form method="post" id="loginForm" autocomplete="on">
  <div asp-validation-summary="ModelOnly" class="alert alert-danger d-flex align-items-start" role="alert">
      <i class="bi bi-exclamation-triangle me-2 mt-1"></i>
     <div></div>
                </div>

   <!-- Tracking Prevention Warning (dismissible) -->
      <div id="trackingWarning" class="alert alert-warning alert-dismissible fade" style="display: none;" role="alert">
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      <div class="d-flex">
    <i class="bi bi-exclamation-triangle me-2 mt-1"></i>
    <div>
           <strong class="small">Browser privacy features detected</strong>
  <p class="mb-2 small">Your browser settings may interfere with security verification.</p>
      <details class="small">
  <summary class="cursor-pointer">Click for solutions</summary>
       <ul class="mb-0 mt-2">
      <li>Allow cookies for this site</li>
      <li>Temporarily disable strict tracking prevention</li>
        <li>Try a different browser</li>
   </ul>
           </details>
         </div>
  </div>
        </div>

    <div class="mb-3">
    <label class="form-label fw-semibold" asp-for="LModel.Email">
   <i class="bi bi-envelope me-1"></i>Email Address
     </label>
           <input type="email" 
   asp-for="LModel.Email" 
       class="form-control form-control-lg"
            placeholder="your.email@example.com" 
       autocomplete="username email"
  autofocus 
         required />
          <span asp-validation-for="LModel.Email" class="text-danger small"></span>
       </div>

   <div class="mb-3">
            <label class="form-label fw-semibold" asp-for="LModel.Password">
    <i class="bi bi-key me-1"></i>Password
     </label>
     <div class="input-group input-group-lg">
      <input type="password" 
     asp-for="LModel.Password" 
        class="form-control"
              placeholder="Enter your password" 
 id="passwordInput"
      autocomplete="current-password"
      required />
        <button class="btn btn-outline-secondary" 
           type="button" 
              id="togglePassword"
          aria-label="Toggle password visibility">
      <i class="bi bi-eye" id="toggleIcon"></i>
        </button>
   </div>
  <span asp-validation-for="LModel.Password" class="text-danger small"></span>
          </div>

         <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="form-check">
    <input type="checkbox" 
  asp-for="LModel.RememberMe" 
            class="form-check-input" 
           id="rememberMe" />
     <label class="form-check-label small" for="rememberMe">
     Remember me for 30 days
       </label>
          </div>
    <a asp-page="/ForgotPassword" class="text-decoration-none small">
           Forgot password?
         </a>
  </div>

  <!-- Hidden field for reCAPTCHA token -->
    <input type="hidden" asp-for="LModel.RecaptchaToken" id="recaptchaToken" />

        <div class="d-grid mb-3">
    <button type="submit" class="btn btn-primary btn-lg fw-semibold" id="loginBtn">
    <i class="bi bi-box-arrow-in-right me-2"></i>Login
          </button>
    </div>

        <!-- reCAPTCHA notice -->
       <div class="text-center mb-3">
       <p class="text-muted small mb-0">
        <i class="bi bi-shield-check me-1"></i>
      Protected by reCAPTCHA
       </p>
         <small class="text-muted" style="font-size: 0.75rem;">
    Google <a href="https://policies.google.com/privacy" target="_blank" class="text-decoration-none">Privacy</a> &
  <a href="https://policies.google.com/terms" target="_blank" class="text-decoration-none">Terms</a> apply
   </small>
     </div>
    </form>
  </div>
        
     <!-- Card Footer -->
    <div class="card-footer bg-light text-center py-3">
         <p class="mb-0 text-muted small">
             Don't have an account? 
 <a asp-page="/Register" class="text-decoration-none fw-semibold">Register here</a>
       </p>
        </div>
   </div>

   <!-- Info Cards -->
  <div class="row mt-3 g-2">
   <div class="col-6">
      <div class="card border-0 bg-light text-center py-2">
 <div class="card-body p-2">
     <i class="bi bi-shield-check text-success"></i>
       <p class="mb-0 small">Secure</p>
</div>
  </div>
            </div>
  <div class="col-6">
     <div class="card border-0 bg-light text-center py-2">
        <div class="card-body p-2">
      <i class="bi bi-lock-fill text-primary"></i>
      <p class="mb-0 small">Encrypted</p>
      </div>
   </div>
    </div>
       </div>
  </div>
  </div>
</div>

@section Scripts {
 <!-- Google reCAPTCHA v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=@siteKey"></script>

    <script>
        (function () {
      'use strict';

        // Password visibility toggle
      const passwordInput = document.getElementById('passwordInput');
   const togglePassword = document.getElementById('togglePassword');
     const toggleIcon = document.getElementById('toggleIcon');

       if (passwordInput && togglePassword && toggleIcon) {
      togglePassword.addEventListener('click', function () {
       const isPassword = passwordInput.type === 'password';
   passwordInput.type = isPassword ? 'text' : 'password';
      toggleIcon.classList.toggle('bi-eye', !isPassword);
     toggleIcon.classList.toggle('bi-eye-slash', isPassword);
 passwordInput.focus();
      });
   }

     const config = {
         siteKey: '@siteKey',
    maxRetries: 2,
  loadTimeout: 15000,
 executeTimeout: 10000
 };

    const elements = {
      form: document.getElementById('loginForm'),
recaptchaToken: document.getElementById('recaptchaToken'),
         loginBtn: document.getElementById('loginBtn'),
            trackingWarning: document.getElementById('trackingWarning')
};

     let state = {
   recaptchaLoaded: false,
      isSubmitting: false,
      retryCount: 0
    };

    function detectPrivacyFeatures() {
   const indicators = [];
   try {
      if (navigator.globalPrivacyControl) indicators.push('GPC');
  if (navigator.doNotTrack === "1") indicators.push('DNT');
     try {
       localStorage.setItem('test', 'test');
      localStorage.removeItem('test');
     } catch {
        indicators.push('Storage Blocked');
        }
            } catch (e) { }

    if (indicators.length > 0) {
          elements.trackingWarning.style.display = 'block';
elements.trackingWarning.classList.add('show');
         return true;
       }
   return false;
      }

       function setButtonLoading() {
   elements.loginBtn.disabled = true;
     elements.loginBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
    state.isSubmitting = true;
 }

      function resetButton() {
    elements.loginBtn.disabled = false;
            elements.loginBtn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Login';
       state.isSubmitting = false;
         }

  function waitForRecaptcha() {
    return new Promise((resolve, reject) => {
    const startTime = Date.now();
        const checkInterval = setInterval(() => {
        if (typeof grecaptcha !== 'undefined' && typeof grecaptcha.ready === 'function') {
             clearInterval(checkInterval);
    state.recaptchaLoaded = true;
        resolve();
    } else if (Date.now() - startTime >= config.loadTimeout) {
      clearInterval(checkInterval);
            reject(new Error('reCAPTCHA load timeout'));
    }
         }, 500);
      });
    }

  function executeRecaptcha() {
   return new Promise((resolve, reject) => {
    if (!state.recaptchaLoaded) return reject(new Error('reCAPTCHA not loaded'));
     const timeout = setTimeout(() => reject(new Error('reCAPTCHA execution timeout')), config.executeTimeout);
    grecaptcha.ready(function () {
    grecaptcha.execute(config.siteKey, { action: 'login' })
       .then(token => { clearTimeout(timeout); resolve(token); })
       .catch(error => { clearTimeout(timeout); reject(error); });
     });
          });
  }

       async function handleSubmit(e) {
   e.preventDefault();
  if (state.isSubmitting) return false;
   state.isSubmitting = true;

          if (!state.recaptchaLoaded) {
         const userChoice = confirm('Security verification unavailable. Try submitting anyway?');
   if (userChoice) {
       elements.recaptchaToken.value = 'browser-blocked';
HTMLFormElement.prototype.submit.call(elements.form);
     } else {
         resetButton();
       }
        return false;
     }

    setButtonLoading();

     try {
       const token = await executeRecaptcha();
  elements.recaptchaToken.value = token;
     HTMLFormElement.prototype.submit.call(elements.form);
       } catch (error) {
           if (state.retryCount < config.maxRetries) {
       state.retryCount++;
     state.isSubmitting = false;
       setTimeout(() => handleSubmit(e), 800);
          return;
         }
          resetButton();
      elements.trackingWarning.style.display = 'block';
     elements.trackingWarning.classList.add('show');
           }
 }

   function init() {
      detectPrivacyFeatures();
          waitForRecaptcha().catch(() => {});
     elements.form.addEventListener('submit', handleSubmit);
     }

      init();
    })();
  </script>
}
